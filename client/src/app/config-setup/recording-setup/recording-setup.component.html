<mat-card class="mat-elevation-z8 recording-setup" xmlns="http://www.w3.org/1999/html">
    <mat-card-title>Set Up Recording</mat-card-title>
    <mat-card-content>
        <ng-container [formGroup]="formGroup">
            <mat-form-field appearance="outline" [style.width.px]="225"
                            matTooltip="Select recording type: None for no recording, Motion Service to use the motion service to detect motion on a specified stream, FTP Triggered to trigger recordings when the localCamera sends an image to the NVR by FTP, and Pullpoint Event Triggered to trigger recordings from a specified pullpoint topic ion the camera."
                            matTooltipClass="tooltip">
                <mat-label>Recording Type</mat-label>
                <mat-select formControlName="recordingType" (selectionChange)="setRecordingType($event)">
                    <mat-option value="none">None</mat-option>
                    <mat-option value="motion">Motion Service</mat-option>
                    <mat-option value="ftp">FTP</mat-option>
                    <mat-option value="pullpoint">Pull point Event Triggered</mat-option>
                </mat-select>
            </mat-form-field>
            @if (localCamera.recordingType === 'ftp') {
                <div>
                    <mat-form-field [style.width.px]="185" appearance="outline"
                                    matTooltip="Select the stream to record from. This would normally be the higher resolution stream,"
                                    matTooltipClass="tooltip">
                        <mat-label>Stream To Record From</mat-label>
                        <mat-select (selectionChange)="setSelectedStream($event)"
                                    formControlName="ftpStreamSelect">
                            <mat-option [value]="'none'">none</mat-option>
                            @for (stream of localCamera.streams | keyvalue: cameraSvc.compareFn; track stream) {
                                <mat-option [value]="stream.key">
                                    {{ stream.key }}
                                </mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                </div>
            } @else if (localCamera.recordingType === 'motion') {
                <div>
                    <mat-form-field [style.width.px]="225" appearance="outline"
                                    matTooltip="Select the stream to monitor for motion. This would normally be the lower resolution stream,"
                                    matTooltipClass="tooltip">
                        <mat-label>Stream To Monitor For Motion</mat-label>
                        <mat-select (selectionChange)="setStreamForMotionDetection($event)"
                                    formControlName="streamForMotionDetection">
                            <mat-option [value]="'none'">none</mat-option>
                            @for (stream of localCamera.streams | keyvalue; track stream) {
                                <mat-option [value]="stream.key">
                                    {{ stream.key }}
                                </mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                </div>
            }
        </ng-container>
        <ng-container matColumnDef="expandedStreamDetail">
            <div class="element-detail mat-elevation-z10">
                <table [dataSource]="localCamera!.streams | keyvalue: cameraSvc.compareFn"
                       class="streams-info mat-elevation-z10" mat-table>
                    <ng-container matColumnDef="threshold">
                        <th *matHeaderCellDef mat-header-cell>Motion Threshold</th>
                        <td *matCellDef="let stream; let streamIndex = index" [style.width.px]="100" mat-cell>
                            <mat-form-field [style.width.px]="95" appearance="outline">
                                <input (input)="setThreshold($event, stream.value)"
                                       [disableControl]="!stream.value.motion.enabled"
                                       [formControl]="getStreamControl(streamIndex, 'threshold')"
                                       autocomplete="off" matInput
                                       matTooltip="Threshold for declaring motion. The threshold is the number of changed pixels counted after noise filtering, masking, despeckle, and labelling"
                                       matTooltipClass="tooltip" maxlength="10" placeholder="Threshold"
                                       type="number">
                                <mat-error
                                        *ngIf="getStreamControl(streamIndex, 'threshold').hasError('max')">
                                    Should be a number between 1 and 2147483647
                                </mat-error>
                                <mat-error
                                        *ngIf="getStreamControl(streamIndex, 'threshold').hasError('min')">
                                    Should be a number between 1 and 2147483647
                                </mat-error>
                                <mat-error
                                        *ngIf="getStreamControl(streamIndex, 'threshold').hasError('required')">
                                    Threshold is required
                                </mat-error>
                            </mat-form-field>
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="trigger_recording_on">
                        <th *matHeaderCellDef mat-header-cell>Trigger Recording On</th>
                        <td *matCellDef="let stream; let streamIndex = index" mat-cell>
                            <mat-form-field [style.width.px]="110" appearance="outline"
                                            matTooltip="Select another stream on the camera to trigger a recording on when motion is detected on {{stream.key}}. Normally you would select the highest resolution stream on the camera."
                                            matTooltipClass="tooltip">

                                <mat-select (selectionChange)="setRecordingTrigger($event, stream.value)"
                                            [disableControl]="!stream.value.motion.enabled"
                                            [formControl]="getStreamControl(streamIndex, 'trigger_recording_on')">
                                    <mat-option [value]="''">
                                        None
                                    </mat-option>
                                    <mat-option
                                            *ngFor="let camStream of localCamera!.streams | keyvalue: cameraSvc.compareFn | excludeOwnStream:stream.key"
                                            [value]="camKey+'.'+camStream.key">
                                        {{ camStream.key }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="preambleFrames">
                        <th *matHeaderCellDef mat-header-cell>Preamble Frames.</th>
                        <td *matCellDef="let stream; let streamIndex = index" mat-cell>
                            <mat-form-field [style.width.px]="70" appearance="outline"
                                            matTooltip="The number of frames to delay the video stream by when recording. The value selected will give a preamble to recordings (time prior to when the recording was triggered) of this value divided by the camera frame rate (seconds). Note that audio packets are also counted as frames, so a higher value may be required if audio is enabled on the stream."
                                            matTooltipClass="tooltip">
                                <mat-select
                                        (selectionChange)="updateStreamField(streamIndex, 'preambleFrames')"
                                        [disableControl]="getPreambleFramesDisabledState(localCamera!, stream)"
                                        [formControl]="getStreamControl(streamIndex, 'preambleFrames')">
                                    <mat-option *ngFor="let preamble of cameraSvc.preambleFrameValues"
                                                [value]="preamble">
                                        {{ preamble }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="mask_file">
                        <th *matHeaderCellDef mat-header-cell> Mask File</th>
                        <td *matCellDef="let stream; let streamIndex = index" mat-cell>
                            <mat-form-field [style.width.px]="220" appearance="outline">
                                <input #fileInput
                                       (change)="uploadMaskFile($event, streamIndex)"
                                       accept=".pgm" hidden style="position: absolute" type="file"/>
                                <div class="file-upload">
                                    <button (click)="fileInput.click()"
                                            [disabled]="!stream.value.motion.enabled" mat-icon-button
                                            matTooltip="Select a mask file to upload. This is a .pgm file where motion detection is disabled where the image is black, shades of grey attenuate motion detection sensitivity, and white areas allow full motion detection sensitivity."
                                            matTooltipClass="tooltip" type="button">

                                        <mat-icon>file_upload</mat-icon>
                                    </button>
                                    <input [formControl]="getStreamControl(streamIndex, 'mask_file')"
                                           matInput readonly type="text">
                                    <button (click)="stream.value.motion.mask_file='';
                                                    getStreamControl(streamIndex, 'mask_file').setValue('')"
                                            [disabled]="!stream.value.motion.enabled" mat-icon-button
                                            matTooltip="Click to clear this field (no mask file)"
                                            matTooltipClass="tooltip" type="button">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <mat-error *ngIf="getStreamControl(streamIndex, 'mask_file')">Please
                                    select a valid .pgm
                                    file, or clear.
                                </mat-error>
                            </mat-form-field>
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="video_width">
                        <th *matHeaderCellDef mat-header-cell> Video Width</th>
                        <td *matCellDef="let stream; let streamIndex = index" mat-cell>
                            <mat-form-field [style.width.px]="80" appearance="outline">
                                <input (blur)="updateStreamField(streamIndex, 'video_width')"
                                       [formControl]="getStreamControl(streamIndex,'video_width')"
                                       autocomplete="off" matInput
                                       matTooltip="The width in pixels of the video on {{stream.key}}. This is required if motion detection is enabled on {{stream.key}}."
                                       matTooltipClass="tooltip" maxlength="4" placeholder="Video Width"
                                       type="number">
                                <mat-error
                                        *ngIf="getStreamControl(streamIndex,'video_width').invalid">
                                    Valid: 90-5000
                                </mat-error>
                            </mat-form-field>
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="video_height">
                        <th *matHeaderCellDef mat-header-cell> Video Height</th>
                        <td *matCellDef="let stream; let streamIndex = index" mat-cell>
                            <mat-form-field [style.width.px]="80" appearance="outline">
                                <input (blur)="updateStreamField(streamIndex, 'video_height')"
                                       [formControl]="getStreamControl(streamIndex,'video_height')"
                                       autocomplete="off" matInput
                                       matTooltip="The height in pixels of the video on {{stream.key}}. This is required if motion detection is enabled on {{stream.key}}."
                                       matTooltipClass="tooltip" maxlength="4" placeholder="Video Height"
                                       type="number">
                                <mat-error
                                        *ngIf="getStreamControl(streamIndex,'video_height').invalid">
                                    Valid: 90-3000
                                </mat-error>
                            </mat-form-field>
                        </td>
                    </ng-container>
                    <tr *matHeaderRowDef="streamColumns" mat-header-row></tr>
                    <tr *matRowDef="let stream; columns: streamColumns" mat-row></tr>
                    <!--                    <tr *matFooterRowDef="streamFooterColumns" mat-footer-row></tr>-->
                </table>
            </div>
        </ng-container>
    </mat-card-content>
    <span class="recording-setup-confirm-group">
          <button color="cancel" mat-raised-button (click)="cancel()"
                  matTooltip="Close this dialogue and undo any changes"
                  matTooltipClass="tooltip">
            Cancel
          </button>
          <button color="warn" mat-raised-button
                  [disabled]="anyInvalid()"
                  (click)="confirmChanges()"
                  matTooltip="Confirm changes and make ready for saving"
                  matTooltipClass="tooltip">
            Confirm
          </button>

    </span>

</mat-card>
