<mat-card class="mat-elevation-z8 recording-setup" xmlns="http://www.w3.org/1999/html">
    <mat-card-title>Set Up Recording</mat-card-title>
    <mat-card-content>
        <ng-container [formGroup]="formGroup">
            <mat-form-field appearance="outline" [style.width.px]="225"
                            matTooltip="Select recording type: None for no recording, Motion Service to use the motion service to detect motion on a specified stream, FTP Triggered to trigger recordings when the camera sends an image to the NVR by FTP, and Pullpoint Event Triggered to trigger recordings from a specified pullpoint topic ion the camera."
                            matTooltipClass="tooltip">
                <mat-label>Recording Type</mat-label>
                <mat-select formControlName="recordingType" (selectionChange)="setRecordingType($event)">
                    <mat-option value="none">None</mat-option>
                    <mat-option value="motion">Motion Service</mat-option>
                    <mat-option value="ftp">FTP Triggered</mat-option>
                    <mat-option value="pullpoint">Pull point Event Triggered</mat-option>
                </mat-select>
            </mat-form-field>

            @if (localCamera.recordingType === 'ftp') {
                <div>
                    <mat-form-field [style.width.px]="185" appearance="outline"
                                    matTooltip="Select the stream to record from. This would normally be the higher resolution stream,"
                                    matTooltipClass="tooltip">
                        <mat-label>Stream To Record From</mat-label>
                        <mat-select (selectionChange)="setSelectedStream($event)"
                                    formControlName="ftpStreamSelect">
                            <mat-option [value]="'none'">none</mat-option>
                            @for(stream of localCamera.streams | keyvalue: cameraSvc.compareFn; track stream) {
                                <mat-option [value]="stream.key">
                                    {{stream.key }}
                                </mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                </div>

                <div>
                    <mat-form-field [style.width.px]="158" appearance="outline"
                                    matTooltip="Select the maximum time in seconds that can elapse between FTP uploads from the camere for the recording to be extended further by this selected time. The absence of another FTP within this window will result in the recording being completed."
                                    matTooltipClass="tooltip">
                        <mat-label>Retrigger Window</mat-label>
                        <mat-select (selectionChange)="setRetriggerWindow($event)"
                                    formControlName="retriggerWindow">
                            @for (win of cameraSvc.ftpRetriggerWindows; track win.value) {
                                <mat-option [value]="win.value">
                                    {{ win.name }}
                                </mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                </div>
            } @else if (localCamera.recordingType === 'motion') {
                <div>
                    <mat-form-field [style.width.px]="225" appearance="outline"
                                    matTooltip="Select the stream to monitor for motion. This would normally be the lower resolution stream,"
                                    matTooltipClass="tooltip">
                        <mat-label>Stream To Monitor For Motion</mat-label>
                        <mat-select (selectionChange)="setStreamForMotionDetection($event)"
                                    formControlName="streamForMotionDetection">
                            <mat-option [value]="'none'">none</mat-option>
                            @for(stream of localCamera.streams | keyvalue; track stream) {
                                <mat-option [value]="stream.key">
                                    {{stream.key }}
                                </mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                </div>
                <mat-form-field [style.width.px]="120" appearance="outline">
                    <mat-label>Motion Threshold</mat-label>
                    <input (input)="setThreshold($event, getStreamForMotionDetection())"
                           [disableControl]="!getStreamForMotionDetection().motion.enabled"
                           formControlName="threshold"
                           autocomplete="off" matInput
                           matTooltip="Threshold for declaring motion. The threshold is the number of changed pixels counted after noise filtering, masking, despeckle, and labelling"
                           matTooltipClass="tooltip" maxlength="10" placeholder="Threshold"
                           type="number">
                    @if (formGroup.get("threshold")?.hasError('max') || formGroup.get("threshold")?.hasError('min')) {
                        <mat-error>
                            Should be a number between 1 and 2147483647
                        </mat-error>
                    }
                    @if (formGroup.get("threshold")?.hasError("required")) {
                        <mat-error>
                            Threshold is required
                        </mat-error>
                    }
                </mat-form-field>

                <ng-container matColumnDef="trigger_recording_on">
                    <mat-form-field [style.width.px]="200" appearance="outline"
                                    matTooltip="Select another stream on the camera to trigger a recording on when motion is detected on {{getStreamKeyForMotionDetection()}}. Normally you would select the highest resolution stream on the camera."
                                    matTooltipClass="tooltip">
                        <mat-label>Trigger Recording On</mat-label>
                        <mat-select (selectionChange)="setRecordingTrigger($event)"
                                    [disableControl]="!motionEnabledOnAnyStream()"
                                    formControlName="triggerRecordingOn">
                            <mat-option value="none">
                                None
                            </mat-option>
                            @for (camStream of localCamera.streams | keyvalue: cameraSvc.compareFn; track camStream) {
                                @if (!camStream.value.motion.enabled) {
                                    <mat-option [value]="camKey+'.'+camStream.key">
                                        {{ camStream.key }}
                                    </mat-option>
                                }
                            }
                        </mat-select>
                    </mat-form-field>
                </ng-container>
<!--                <ng-container matColumnDef="mask_file">-->
<!--                    <th *matHeaderCellDef mat-header-cell> Mask File</th>-->
<!--                    <td *matCellDef="let stream; let streamIndex = index" mat-cell>-->
<!--                        <mat-form-field [style.width.px]="220" appearance="outline">-->
<!--                            <input #fileInput-->
<!--                                   (change)="uploadMaskFile($event, camKey, camIndex, streamIndex)"-->
<!--                                   accept=".pgm" hidden style="position: absolute" type="file"/>-->
<!--                            <div class="file-upload">-->
<!--                                <button (click)="fileInput.click()"-->
<!--                                        [disabled]="!stream.value.motion.enabled" mat-icon-button-->
<!--                                        matTooltip="Select a mask file to upload. This is a .pgm file where motion detection is disabled where the image is black, shades of grey attenuate motion detection sensitivity, and white areas allow full motion detection sensitivity."-->
<!--                                        matTooltipClass="tooltip" type="button">-->

<!--                                    <mat-icon>file_upload</mat-icon>-->
<!--                                </button>-->
<!--                                <input [formControl]="getStreamControl(camIndex, streamIndex, 'mask_file')"-->
<!--                                       matInput readonly type="text">-->
<!--                                <button (click)="stream.value.motion.mask_file='';-->
<!--                                                    getStreamControl(camIndex, streamIndex, 'mask_file').setValue('')"-->
<!--                                        [disabled]="!stream.value.motion.enabled" mat-icon-button-->
<!--                                        matTooltip="Click to clear this field (no mask file)"-->
<!--                                        matTooltipClass="tooltip" type="button">-->
<!--                                    <mat-icon>close</mat-icon>-->
<!--                                </button>-->
<!--                            </div>-->
<!--                            <mat-error *ngIf="getStreamControl(camIndex, streamIndex, 'mask_file')">Please-->
<!--                                select a valid .pgm-->
<!--                                file, or clear.-->
<!--                            </mat-error>-->
<!--                        </mat-form-field>-->
<!--                    </td>-->
<!--                </ng-container>-->
<!--                <ng-container matColumnDef="video_width">-->
<!--                    <th *matHeaderCellDef mat-header-cell> Video Width</th>-->
<!--                    <td *matCellDef="let stream; let streamIndex = index" mat-cell>-->
<!--                        <mat-form-field [style.width.px]="80" appearance="outline">-->
<!--                            <input (blur)="updateStreamField(camIndex, streamIndex, 'video_width')"-->
<!--                                   [formControl]="getStreamControl(camIndex, streamIndex,'video_width')"-->
<!--                                   autocomplete="off" matInput-->
<!--                                   matTooltip="The width in pixels of the video on {{stream.key}}. This is required if motion detection is enabled on {{stream.key}}."-->
<!--                                   matTooltipClass="tooltip" maxlength="4" placeholder="Video Width"-->
<!--                                   type="number">-->
<!--                            <mat-error-->
<!--                                    *ngIf="getStreamControl(camIndex, streamIndex,'video_width').invalid">-->
<!--                                Valid: 90-5000-->
<!--                            </mat-error>-->
<!--                        </mat-form-field>-->
<!--                    </td>-->
<!--                </ng-container>-->
<!--                <ng-container matColumnDef="video_height">-->
<!--                    <th *matHeaderCellDef mat-header-cell> Video Height</th>-->
<!--                    <td *matCellDef="let stream; let streamIndex = index" mat-cell>-->
<!--                        <mat-form-field [style.width.px]="80" appearance="outline">-->
<!--                            <input (blur)="updateStreamField(camIndex, streamIndex, 'video_height')"-->
<!--                                   [formControl]="getStreamControl(camIndex, streamIndex,'video_height')"-->
<!--                                   autocomplete="off" matInput-->
<!--                                   matTooltip="The height in pixels of the video on {{stream.key}}. This is required if motion detection is enabled on {{stream.key}}."-->
<!--                                   matTooltipClass="tooltip" maxlength="4" placeholder="Video Height"-->
<!--                                   type="number">-->
<!--                            <mat-error-->
<!--                                    *ngIf="getStreamControl(camIndex, streamIndex,'video_height').invalid">-->
<!--                                Valid: 90-3000-->
<!--                            </mat-error>-->
<!--                        </mat-form-field>-->
<!--                    </td>-->
<!--                </ng-container>-->

            }
            @if(localCamera.recordingType !== 'none') {
                <div>
                    <ng-container matColumnDef="preambleFrames">
                        <mat-form-field [style.width.px]="160" appearance="outline"
                                        matTooltip="The number of frames to delay the video stream by when recording. The value selected will give a preamble to recordings (time prior to when the recording was triggered) of this value divided by the camera frame rate (seconds). Note that audio packets are also counted as frames, so a higher value may be required if audio is enabled on the stream."
                                        matTooltipClass="tooltip">
                            <mat-label>Preamble Frames.</mat-label>
                            <mat-select
                                    (selectionChange)="setPreambleFrames($event)"
                                    [disableControl]="getPreambleFramesDisabledState()"
                                    formControlName="preambleFrames">
                                <mat-option *ngFor="let preamble of cameraSvc.preambleFrameValues"
                                            [value]="preamble">
                                    {{ preamble }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </ng-container>
                </div>
            }
        </ng-container>
        <br>
        <span class="recording-setup-confirm-group">
      <button color="cancel" mat-raised-button (click)="cancel()"
              matTooltip="Close this dialogue and undo any changes"
              matTooltipClass="tooltip">
        Cancel
      </button>
      <button color="warn" mat-raised-button
              [disabled]="anyInvalid()"
              (click)="confirmChanges()"
              matTooltip="Confirm changes and make ready for saving"
              matTooltipClass="tooltip">
        Confirm
      </button>
    </span>
    </mat-card-content>
</mat-card>
